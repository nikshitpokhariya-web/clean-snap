<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report an Issue - Clean City Initiative</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    /* Applying the Inter font family */
    body {
      font-family: 'Inter', sans-serif;
    }

    /* Using the same custom gradient for consistency */
    .bg-custom-gradient {
      background-image: linear-gradient(to bottom, #FDBF68, #EAF2E2, #A8D8B9);
    }

    /* Style for the image preview */
    #image-preview {
      width: 100%;
      height: 200px;
      border: 2px dashed #cbd5e1;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f8fafc;
      color: #94a3b8;
      font-weight: 500;
      background-size: cover;
      background-position: center;
    }

    /* Styles for the map modal */
    #map-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    #map-container {
      width: 90%;
      height: 85%;
      max-width: 800px;
      background-color: white;
      border-radius: 0.5rem;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #map {
      flex-grow: 1;
      /* Important for Leaflet */
      background-color: #ddd;
    }
  </style>
</head>

<body class="bg-custom-gradient">

  <div class="relative min-h-screen flex flex-col items-center justify-center p-4">
    <div class="w-full max-w-md z-10 bg-white/80 backdrop-blur-md p-8 rounded-2xl shadow-lg">

      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800">Report an Issue</h1>
        <p class="text-gray-600 mt-2">Help us keep the city clean.</p>
      </div>

      <form id="report-form" class="space-y-6">

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Upload or Capture Photo</label>
          <div id="image-preview"><span>Image Preview</span></div>
          <input type="file" name="photo" id="photo-upload" accept="image/*" capture="environment"
            class="mt-2 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
            required>
        </div>

        <div>
          <label for="full-address" class="block text-sm font-medium text-gray-700 mb-1">Full Address</label>
          <textarea name="full-address" id="full-address" rows="3"
            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#26A69A]"
            placeholder="Enter the full address or nearby landmark..." required></textarea>
        </div>

        <div>
          <label for="map-link" class="block text-sm font-medium text-gray-700 mb-1">Pinpoint Location on Map</label>
          <div class="flex items-center space-x-2">
            <input type="url" name="map-link" id="map-link"
              class="flex-grow w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-100"
              placeholder="Location link will appear here" readonly required>
            <button type="button" id="location-btn"
              class="bg-indigo-500 text-white px-4 py-3 rounded-lg font-semibold hover:bg-indigo-600 transition-colors duration-300">Location</button>
          </div>
          <p id="location-status" class="text-sm text-green-600 mt-1 h-4"></p>
        </div>

        <div class="pt-4">
          <button type="submit"
            class="w-full bg-[#26A69A] text-white py-3 rounded-lg shadow-md hover:bg-[#208a7f] transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-[#26A69A] focus:ring-offset-2 text-lg font-semibold">
            Submit Report
          </button>
        </div>
      </form>
    </div>
  </div>

  <div id="map-modal" style="display: none;">
    <div id="map-container">
      <div id="map"></div>
      <div class="p-4 bg-gray-50 border-t">
        <p class="text-sm text-center text-gray-600 mb-2">Drag the pin to the exact location of the issue.</p>
        <button type="button" id="confirm-location-btn"
          class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700">Confirm
          Location</button>
      </div>
    </div>
  </div>

  <script>
    // Form and DOM element references
    const reportForm = document.getElementById('report-form');
    const photoUpload = document.getElementById('photo-upload');
    const imagePreview = document.getElementById('image-preview');
    const locationBtn = document.getElementById('location-btn');
    const mapLinkInput = document.getElementById('map-link');
    const locationStatus = document.getElementById('location-status');
    const mapModal = document.getElementById('map-modal');
    const confirmLocationBtn = document.getElementById('confirm-location-btn');

    // Leaflet.js Map variables
    let map;
    let marker;

    // --- Event Listeners ---

    // Display image preview (No changes needed here)
    photoUpload.addEventListener('change', () => {
      const file = photoUpload.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          imagePreview.style.backgroundImage = url('${e.target.result}');
          imagePreview.textContent = '';
        };
        reader.readAsDataURL(file);
      }
    });

    // Open the map modal and get user's location (Updated for Leaflet.js)
    locationBtn.addEventListener('click', () => {
      mapModal.style.display = 'flex';
      locationStatus.textContent = 'Fetching your location...';

      // Your default location in Ranikhet, Uttarakhand
      const defaultLocation = [29.6447, 79.6539];

      // REWRITTEN: This function now uses Leaflet.js
      const initializeMapWithMarker = (location) => {
        // If map is already initialized, just set the view
        if (map) {
          map.setView(location, 18);
          marker.setLatLng(location);
          return;
        }

        // Initialize the Leaflet Map
        map = L.map('map').setView(location, 18);

        // Add the OpenStreetMap tile layer (the actual map image)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Add a draggable marker to the map
        marker = L.marker(location, {
          draggable: true,
          title: "Drag me to the exact spot!"
        }).addTo(map);

        // CRUCIAL: Fixes map not loading tiles correctly in a modal
        setTimeout(() => {
          map.invalidateSize();
        }, 100);
      };

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const userLocation = [position.coords.latitude, position.coords.longitude];
            locationStatus.textContent = '';
            initializeMapWithMarker(userLocation);
          },
          () => {
            locationStatus.textContent = '';
            alert("Could not get your location. Defaulting to a central location. Please drag the pin to the correct spot.");
            initializeMapWithMarker(defaultLocation);
          }
        );
      } else {
        alert("Geolocation is not supported. Defaulting to a central location. Please drag the pin to the correct spot.");
        locationStatus.textContent = '';
        initializeMapWithMarker(defaultLocation);
      }
    });

    // Confirm the selected location from the map (Updated for Leaflet.js)
    confirmLocationBtn.addEventListener('click', () => {
      if (marker) {
        // Leaflet's way of getting marker position
        const finalPosition = marker.getLatLng();
        const latitude = finalPosition.lat;
        const longitude = finalPosition.lng;

        // Generate a standard OpenStreetMap URL
        const mapsUrl = 'https://www.openstreetmap.org/?mlat=${latitude}&mlon=${longitude}#map=18/${latitude}/${longitude}';

        mapLinkInput.value = mapsUrl;
        locationStatus.textContent = 'Exact location confirmed!';
        mapModal.style.display = 'none';
      } else {
        alert("Map marker not available. Please try opening the map again.");
      }
    });

    // Handle the final form submission (No changes needed here)
    reportForm.addEventListener('submit', (event) => {
      event.preventDefault();
      // This is where you would have your backend submission logic (fetch, FormData, etc.)

      const reportData = {
        photo: photoUpload.files[0] ? photoUpload.files[0].name : 'No photo',
        fullAddress: document.getElementById('full-address').value,
        mapLink: mapLinkInput.value
      };

      console.log('New Report Submitted:', reportData);
      alert('Thank you! Your report has been submitted.');

      reportForm.reset();
      imagePreview.style.backgroundImage = 'none';
      imagePreview.textContent = 'Image Preview';
      locationStatus.textContent = '';
    });
  </script>

</body>

</html>